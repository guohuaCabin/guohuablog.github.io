<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="简单的一个技术博客，用来作为学习笔记和日常记录使用。"><title>读 SDWebImage 一 使用分析 | 喂、三二一</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">读 SDWebImage 一 使用分析</h1><a id="logo" href="/.">喂、三二一</a><p class="description">低调、踏实、前行。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">读 SDWebImage 一 使用分析</h1><div class="post-meta">Sep 29, 2018<span> | </span><span class="category"><a href="/categories/iOS/">iOS</a></span></div><div class="post-content"><p>SDWebImage整体的框架：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SDWebImage</span><br><span class="line">    -</span><br><span class="line">    |<span class="string">--SDWebImageCompat :一些兼容性相关的宏定义 </span></span><br><span class="line"><span class="string">    </span>|<span class="string">--SDWebImageOperation :只有一个 cancel 方法的 protocal</span></span><br><span class="line"><span class="string">    </span>|</span><br><span class="line">    |<span class="string">--Downloader :下载模块</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">-- SDWebImageDownloader</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">-- SDWebImageDownloaderOperation</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span></span><br><span class="line"><span class="string">    </span>|<span class="string">--Cache :内存和硬盘缓存模块</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">-- SDImageCache</span></span><br><span class="line"><span class="string">    </span>|</span><br><span class="line">    |<span class="string">--Utils :</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">-- SDWebImageManager 将缓存和下载模块结合起来使用</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">-- SDWebImagePrefetcher 预下载图片</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">-- SDWebImageDecoder</span></span><br><span class="line"><span class="string">    </span>|</span><br><span class="line">    |<span class="string">--Categories : UIKit 相关的Category,方便使用,还支持 MKAnnotationView</span></span><br><span class="line"><span class="string">        </span>|<span class="string">-- MKAnnotationView+WebCache</span></span><br><span class="line"><span class="string">        </span>|<span class="string">-- UIButton+WebCache</span></span><br><span class="line"><span class="string">        </span>|<span class="string">-- UIImageView+WebCache</span></span><br><span class="line"><span class="string">    -</span></span><br><span class="line"><span class="string">    ... ...</span></span><br></pre></td></tr></table></figure>
<h2 id="1、使用配置"><a href="#1、使用配置" class="headerlink" title="1、使用配置"></a>1、使用配置</h2><p>为项目添加一个通用的只读缓存的存储路径:</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">NSString</span> *bundlePath = [[<span class="symbol">NSBundle</span> mainBundle].resourcePath stringByAppendingPathComponent:@<span class="string">"CustomPathImages"</span>];</span><br><span class="line"> </span><br><span class="line">[[<span class="symbol">SDImageCache</span> sharedImageCache] addReadOnlyCachePath:bundlePath];</span><br></pre></td></tr></table></figure>
<h2 id="2、-身份鉴定"><a href="#2、-身份鉴定" class="headerlink" title="2、 身份鉴定"></a>2、 身份鉴定</h2><p>如果请求的图片需要身份鉴定才可以获取，SDWebImage提供了两种方法：</p>
<p>一种是直接设置用户名和密码：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[SDWebImageManager <span class="keyword">sharedManager].imageDownloader.username </span>= @<span class="string">"httpwatch"</span><span class="comment">;</span></span><br><span class="line">[SDWebImageManager <span class="keyword">sharedManager].imageDownloader.password </span>= @<span class="string">"httpwatch01"</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>另一种是通过 <code>NSURLCredential</code> 属性去配置用户名和密码</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NSURLCredential *<span class="keyword">new</span><span class="type">Credential</span> = [NSURLCredential credentialWithUser:<span class="type"></span>@<span class="string">"httpwatch"</span> password:<span class="type"></span>@<span class="string">"httpwatch01"</span> persistence:<span class="type">NSURLCredentialPersistenceNone</span>];</span><br><span class="line">[SDWebImageManager sharedManager].imageDownloader.urlCredential = <span class="keyword">new</span><span class="type">Credential</span>;</span><br></pre></td></tr></table></figure>
<p>这里做下测试：<br>图片地址（需要身份验证才可以查看）：<a href="http://www.httpwatch.com/httpgallery/authentication/authenticatedimage/default.aspx?0.35786508303135633" target="_blank" rel="noopener">http://www.httpwatch.com/httpgallery/authentication/authenticatedimage/default.aspx?0.35786508303135633</a></p>
<p>浏览器去打开会弹出提示框让输入验证信息，如下：<br><img src="http://obzx0h1re.bkt.clouddn.com/Authentication_Image_SDWebImage.jpg" alt="Authentication_Image_SDWebImage"></p>
<p>这种情况下，在项目中就需要配置身份验证信息，否则图片无法显示。</p>
<h2 id="3、设置要附加到每个下载HTTP请求的HTTP标头的值"><a href="#3、设置要附加到每个下载HTTP请求的HTTP标头的值" class="headerlink" title="3、设置要附加到每个下载HTTP请求的HTTP标头的值"></a>3、设置要附加到每个下载HTTP请求的HTTP标头的值</h2><p>如果想要自定义图片请求的Request Header时，可以使用以下方法：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置要附加到每个下载HTTP请求的HTTP标头的值。</span></span><br><span class="line">  [SDWebImageManager.sharedManager.imageDownloader <span class="string">setValue:</span>@<span class="string">"&amp;&amp;Jason&amp;&amp;"</span> <span class="string">forHTTPHeaderField:</span>@<span class="string">"****SDWebImageM****"</span>];</span><br></pre></td></tr></table></figure>
<p>通过charles抓包可以看到设置的Request Header：</p>
<p><img src="http://obzx0h1re.bkt.clouddn.com/setValue_1_SDWebImageManager.jpg" alt="setValue_1_SDWebImageManager"></p>
<p><img src="http://obzx0h1re.bkt.clouddn.com/setValue_2_SDWebImageManager.jpg" alt="setValue_2_SDWebImageManager"></p>
<h2 id="4、图片下载执行顺序"><a href="#4、图片下载执行顺序" class="headerlink" title="4、图片下载执行顺序"></a>4、图片下载执行顺序</h2><p>执行顺序分：LIFO（先入后出） 和 FIFO（先进先出）两种<br>默认值为 <code>FIFO</code> 。</p>
<p><code>SDWebImageDownloaderExecutionOrder</code> ：枚举类型</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SDWebImageManager.<span class="keyword">sharedManager.imageDownloader.executionOrder </span>= SDWebImageDownloaderLIFOExecutionOrder<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h2 id="5、手动清理缓存"><a href="#5、手动清理缓存" class="headerlink" title="5、手动清理缓存"></a>5、手动清理缓存</h2><p>SDWebImage提供了手动清理缓存操作，从SDWebImage的工作原理可以想到清理缓存需清理两处：内存和磁盘。</p>
<p>注：这里清理的仅仅是SDWebImage的缓存，并没有清理整个app的缓存</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[SDWebImageManager.sharedManager.imageCache clearMemory]</span><span class="comment">;</span></span><br><span class="line"><span class="section">[SDWebImageManager.sharedManager.imageCache clearDiskOnCompletion:nil]</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="6、将图片显示到ImgaeView-Button上"><a href="#6、将图片显示到ImgaeView-Button上" class="headerlink" title="6、将图片显示到ImgaeView / Button上"></a>6、将图片显示到ImgaeView / Button上</h2><p>Button图片或者背景图的显示和ImageView同理，只是多了几个额外的参数,下面以ImageView为例。</p>
<h3 id="6-1、图片显示动画"><a href="#6-1、图片显示动画" class="headerlink" title="6.1、图片显示动画"></a>6.1、图片显示动画</h3><p>图片显示过渡类型：<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.customImageView.sd_imageTransition = SDWebImageTransition.curlUpTransition<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>SDWebImage提供了七种动画过渡类型，分别是：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Fade transition. 淡出过渡</span></span><br><span class="line"><span class="meta">@property</span> (nonatomic, <span class="class"><span class="keyword">class</span>, <span class="type">nonnull</span>, <span class="type">readonly) SDWebImageTransition *fadeTransition;</span></span></span><br><span class="line"><span class="comment">/// Flip from left transition. 从左过渡翻转。</span></span><br><span class="line"><span class="meta">@property</span> (nonatomic, <span class="class"><span class="keyword">class</span>, <span class="type">nonnull</span>, <span class="type">readonly) SDWebImageTransition *flipFromLeftTransition;</span></span></span><br><span class="line"><span class="comment">/// Flip from right transition. 从右过渡翻转。</span></span><br><span class="line"><span class="meta">@property</span> (nonatomic, <span class="class"><span class="keyword">class</span>, <span class="type">nonnull</span>, <span class="type">readonly) SDWebImageTransition *flipFromRightTransition;</span></span></span><br><span class="line"><span class="comment">/// Flip from top transition. 从顶部过渡翻转。</span></span><br><span class="line"><span class="meta">@property</span> (nonatomic, <span class="class"><span class="keyword">class</span>, <span class="type">nonnull</span>, <span class="type">readonly) SDWebImageTransition *flipFromTopTransition;</span></span></span><br><span class="line"><span class="comment">/// Flip from bottom transition. 从底部过渡翻转。</span></span><br><span class="line"><span class="meta">@property</span> (nonatomic, <span class="class"><span class="keyword">class</span>, <span class="type">nonnull</span>, <span class="type">readonly) SDWebImageTransition *flipFromBottomTransition;</span></span></span><br><span class="line"><span class="comment">/// Curl up transition. 向上卷起过渡。</span></span><br><span class="line"><span class="meta">@property</span> (nonatomic, <span class="class"><span class="keyword">class</span>, <span class="type">nonnull</span>, <span class="type">readonly) SDWebImageTransition *curlUpTransition;</span></span></span><br><span class="line"><span class="comment">/// Curl down transition. 向下卷起过渡。</span></span><br><span class="line"><span class="meta">@property</span> (nonatomic, <span class="class"><span class="keyword">class</span>, <span class="type">nonnull</span>, <span class="type">readonly) SDWebImageTransition *curlDownTransition;</span></span></span><br></pre></td></tr></table></figure>
<h3 id="6-2-、图片显示方法"><a href="#6-2-、图片显示方法" class="headerlink" title="6.2 、图片显示方法"></a>6.2 、图片显示方法</h3><p>SDWebImage提供7种方法去显示图片，我们只看第7个，因为其他6种方法最后都是通过该方法图显示图片的。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">          placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                   options:(SDWebImageOptions)options</span><br><span class="line">                  progress:(<span class="keyword">nullable</span> SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                 completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock;</span><br></pre></td></tr></table></figure>
<p><strong>通过给定的URL加载图片并将其加载到此imageView中。它适用于静态和动态图像。<br>先从缓存和磁盘中寻找该图片，有则直接显示，无就下载显示并缓存。<br>下载是异步和缓存的，SDWebImage会先显示传入的占位符，直到请求完成</strong></p>
<h4 id="6-2-1分析参数"><a href="#6-2-1分析参数" class="headerlink" title="6.2.1分析参数"></a>6.2.1分析参数</h4><ol>
<li>@param url  ：图片URL</li>
<li>@param placeholder ：占位符（最初要设置的图像，直到图像请求完成。）</li>
<li>@param options ：下载图像时使用的选项。</li>
<li>@param progressBlock ：下载图像时调用的block代码块（稍后分析）</li>
<li>@param completedBlock ： 操作完成时调用的代码块。 该代码块没有返回值（稍后分析）</li>
</ol>
<p><strong>解析 options 选项（枚举类型）</strong></p>
<blockquote>
<p><code>SDWebImageRetryFailed = 1 &lt;&lt; 0,</code><br>  默认情况下当通过URL下载图片失败后，该URL就被加入黑名单，之后SDWebImage不会再去尝试下载。此标志作用就是禁用该黑名单，也就是说使用SDWebImageRetryFailed后，图片下载失败仍会尝试下载</p>
<p> <code>SDWebImageLowPriority = 1 &lt;&lt; 1,</code><br>  默认情况下图片在UI交互期间下载，此标志的作用就是禁用该功能。例如：在UIScrollView减速时导致延迟下载。</p>
<p><code>SDWebImageCacheMemoryOnly = 1 &lt;&lt; 2,</code><br>  此标志作用是：图片下载完成后仅缓存到内存，不缓存在磁盘上</p>
<p><code>SDWebImageProgressiveDownload = 1 &lt;&lt; 3,</code><br>  此标志启用渐进式下载，图像在下载过程中逐步显示，就像浏览器一样。<br>  默认情况下，图像仅在完全下载后显示。</p>
<p><code>SDWebImageRefreshCached = 1 &lt;&lt; 4,</code><br>  即使缓存中存在该图片，也尊重HTTP响应缓存控制，在需要时从远程刷新图片。<br>  磁盘缓存将由 <code>NSURLCache</code> 替代 <code>SDWebImage</code> 去处理，这样也将导致性能略有下降。<br>  该选项有助于处理同一个URL请求但更换图片的情况，例如Facebook图形api配置文件的图片。<br>  如果刷新了缓存图片，则使用缓存图片调用一次完成block代码块，再使用最终的图片调用完成block代码块。<br>  仅当你无法使用嵌入式缓存清除参数使URL保持静态时，才使用该标志。</p>
<p><code>SDWebImageContinueInBackground = 1 &lt;&lt; 5,</code><br>  在<code>iOS 4+</code>中，如果app进入后台也继续下载图片，这是通过询问系统实现的。<br>  在后台有额外的时间让请求完成，如果后台任务到期，则操作被取消。</p>
<p><code>SDWebImageHandleCookies = 1 &lt;&lt; 6,</code><br>  通过<code>NSMutableURLRequest.HTTPShouldHandleCookies = YES</code>设置处理在 <code>NSHTTPCookieStore</code>中的cookies。</p>
<p>  <code>SDWebImageAllowInvalidSSLCertificates = 1 &lt;&lt; 7,</code><br>  启用允许不受信任的SSL证书（用于测试目的，在生产中谨慎使用）</p>
<p><code>SDWebImageHighPriority = 1 &lt;&lt; 8,</code><br>  默认情况下，图像按其排队顺序加载，此标志将它们移动到队列的前面</p>
<p><code>SDWebImageDelayPlaceholder = 1 &lt;&lt; 9,</code><br>  默认情况下，加载图像时会加载占位符。 此标志将延迟加载占位符图像，直到图像加载完毕。</p>
<p><code>SDWebImageTransformAnimatedImage = 1 &lt;&lt; 10,</code><br>  我们通常不会在动画图像上调用transformDownloadedImage委托方法，因为大多数转换代码会破坏它。如果使用必须使用此标志来转换它们。  </p>
<p><code>SDWebImageAvoidAutoSetImage = 1 &lt;&lt; 11,</code><br>  默认情况下，下载后会将图像添加到imageView。 但在某些情况下，我们想要<br>  在设置图像之前手动处理一些东西（例如应用滤镜或添加交叉渐变动画）请使用此标志</p>
<p><code>SDWebImageScaleDownLargeImages = 1 &lt;&lt; 12,</code><br>  默认情况下，图像会根据其原始大小进行解码。 在iOS上，此标志将缩小<br>  图像尺寸与设备的受限内存兼容。（如果设置了“SDWebImageProgressiveDownload”标志，则停用缩小比例。）</p>
<p><code>SDWebImageQueryDataWhenInMemory = 1 &lt;&lt; 13,</code><br>  默认情况下，当图像缓存在内存中时，我们不查询磁盘数据。 此掩码可以强制同时查询磁盘数据。<br>  建议将此标志与<code>SDWebImageQueryDiskSync</code>一起使用，以确保图像在同一个runloop中加载。 </p>
<p><code>SDWebImageQueryDiskSync = 1 &lt;&lt; 14,</code><br>  默认情况下，我们同步查询内存缓存，异步查询磁盘缓存。 此掩码可以强制同步查询磁盘缓存，以确保在同一个runloop中加载映像。<br>  如果禁用内存缓存或在某些其他情况下，此标志可以避免在单元重用期间闪烁。</p>
<p><code>SDWebImageFromCacheOnly = 1 &lt;&lt; 15,</code><br>  默认情况下，当缓存丢失时，将从网络下载映像。此标志可以阻止网络仅从缓存加载。</p>
<p><code>SDWebImageForceTransition = 1 &lt;&lt; 16</code><br>  默认情况下，当您使用 <code>SDWebImageTransition</code> 在图像加载完成后进行某些视图转换时，此转换仅适用于从网络下载图像。 此掩码也可以强制为内存和磁盘缓存应用视图转换。</p>
</blockquote>
<p><strong>解析progressBlock代码块</strong><br>下载图像时重复调用的代码块,在后台队列上执行,包含三个参数，分别是：<br>NSInteger receivedSize：接收到的图片大小<br>NSInteger expectedSize：预期的图片大小<br>NSURL * _Nullable targetURL：目标图片的URL</p>
<p><strong>completedBlock代码块</strong><br>包含四个参数：<br>(UIImage <em> _Nullable image, NSError </em> _Nullable error, SDImageCacheType cacheType, NSURL * _Nullable imageURL)</p>
<ol>
<li>第一个参数是：请求得到的UIImage，如果请求失败，该图像参数是为nil</li>
<li>第二个参数： 请求结果中可能包含的NSError</li>
<li>第三个参数： 是枚举，缓存类型，通过类型判断图片从哪里获取。分三种： SDImageCacheTypeNone 、SDImageCacheTypeDisk、SDImageCacheTypeMemory 。</li>
<li>第四个参数：图片的URL。</li>
</ol>
<p>以下是其他6种显示图片的方法，只做简单的分析：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *通过给定的URL加载图片并将其加载到此imageView中。它适用于静态和动态图像</span></span><br><span class="line"><span class="comment"> * 先从缓存和磁盘中寻找，有则显示，无就下载显示并缓存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">          placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder ;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">          placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                   options:(SDWebImageOptions)options ;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">                 completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">          placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                 completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock ;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">          placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                   options:(SDWebImageOptions)options</span><br><span class="line">                 completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">          placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                   options:(SDWebImageOptions)options</span><br><span class="line">                  progress:(<span class="keyword">nullable</span> SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                 completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock;</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="7、图像显示的最终调用方法解析"><a href="#7、图像显示的最终调用方法解析" class="headerlink" title="7、图像显示的最终调用方法解析"></a>7、图像显示的最终调用方法解析</h2><p>通过上面的七种方法来加载图像，其实前6种都是调用第7种完善的方法。而这7种方法都是调用的另一种方法。如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sd_internalSetImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">                  placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                           options:(SDWebImageOptions)options</span><br><span class="line">                      operationKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)operationKey</span><br><span class="line">                     setImageBlock:(<span class="keyword">nullable</span> SDSetImageBlock)setImageBlock</span><br><span class="line">                          progress:(<span class="keyword">nullable</span> SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                         completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock</span><br><span class="line">                           context:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)context;</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ol>
<li>@param url  ：图像URL</li>
<li>@param placeholder ：初始化image，知道图像请求完成</li>
<li>@param options ：图像下载时的选项</li>
<li>@param operationKey ：用作操作key的字符串。 如果为nil，将使用类名（ImageView加载图像时直接传的nil，Button加载图像时传【字符串和UIControlState状态的拼接】）</li>
<li>@param setImageBlock ： 用于自定义设置图像的代码块</li>
<li>@param progressBlock ： 下载图像时调用的代码块</li>
<li>@param completedBlock ： 操作完成时调用的代码块。 该块没有返回值</li>
<li>@param context ： 具有执行特定更改或过程的额外信息的上下文。</li>
</ol>
<p>其实可以看出：除了参数4、5、8之外，剩下的都是和ImageView加载图像时参数一样，因为这本就是ImageView加载图像最终调用的方法。而参数4、5、8则是Button加载图像传入的参数，这也证明了代码的高内聚力。</p>
<p><strong>SDSetImageBlock：</strong><br>包含两个参数：<br>(UIImage <em>image, NSData </em>imageData)<br>我们通常在该回调中自定义图像（比如说压缩、剪切、加滤镜、加蒙层等）<br>或者直接简单的显示图像：<code>[weakSelf setImage:image forState:state];</code></p>
<p>看下整体的代码：<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="literal">self</span> sd_internalSetImageWithURL:url</span><br><span class="line">                    placeholderImage:placeholder</span><br><span class="line">                             options:options</span><br><span class="line">                        operationKey:imageOperationKeyForState(<span class="keyword">state</span>)</span><br><span class="line">                       <span class="built_in">set</span>ImageBlock:^(UIImage *image, NSData *imageData) &#123;</span><br><span class="line">                           [weakSelf <span class="built_in">set</span>Image:image <span class="keyword">for</span>State:<span class="keyword">state</span>]; //自定义图像</span><br><span class="line">                       &#125;</span><br><span class="line">                            progress:nil</span><br><span class="line">                           completed:completedBlock];</span><br></pre></td></tr></table></figure></p>
<p> <strong>context ： 上下文信息</strong></p>
<p>这个是最后才加上的，为的是获取额外的信息（加载的过程信息、更改信息等）</p>
<h3 id="7-1、分析最终的加载图像的方法"><a href="#7-1、分析最终的加载图像的方法" class="headerlink" title="7.1、分析最终的加载图像的方法"></a>7.1、分析最终的加载图像的方法</h3><p>该方法是针对UIView的子类进行图像加载的（例如：UIImageView、UIButton）<br>下面会拆成代码片段一步一步看</p>
<h4 id="7-1-1、第一步"><a href="#7-1-1、第一步" class="headerlink" title="7.1.1、第一步"></a>7.1.1、第一步</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> imageURLKey;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> *validOperationKey = operationKey ?: <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>]);</span><br><span class="line">[<span class="keyword">self</span> sd_cancelImageLoadOperationWithKey:validOperationKey];</span><br><span class="line">objc_setAssociatedObject(<span class="keyword">self</span>, &amp;imageURLKey, url, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br></pre></td></tr></table></figure>
<ol>
<li>初始化一个有效的操作key，如果传入的 <code>operationKey</code> 为nil，则赋值为类名 <code>NSStringFromClass([self class])</code> </li>
<li>通过 <code>operationKey</code> 从队列中取消正在进行的下载操作。</li>
<li>最后将该类与图像的URL关联起来，关联类型是 ：<code>OBJC_ASSOCIATION_RETAIN_NONATOMIC</code> (指定对关联对象的强引用。)</li>
</ol>
<p>以下列出所有的关联类型</p>
<table>
<thead>
<tr>
<th style="text-align:left">关联策略</th>
<th style="text-align:left">等价属性</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">OBJC_ASSOCIATION_ASSIGN</td>
<td style="text-align:left">@property (assign) or @property (unsafe_unretained)</td>
<td style="text-align:left">弱引用关联对象</td>
</tr>
<tr>
<td style="text-align:left">OBJC_ASSOCIATION_RETAIN_NONATOMIC</td>
<td style="text-align:left">@property (strong, nonatomic)</td>
<td style="text-align:left">强引用关联对象，且为非原子操作</td>
</tr>
<tr>
<td style="text-align:left">OBJC_ASSOCIATION_COPY_NONATOMIC</td>
<td style="text-align:left">@property (copy, nonatomic)</td>
<td style="text-align:left">复制关联对象，且为非原子操作</td>
</tr>
<tr>
<td style="text-align:left">OBJC_ASSOCIATION_RETAIN</td>
<td style="text-align:left">@property (strong, atomic)</td>
<td style="text-align:left">强引用关联对象，且为原子操作</td>
</tr>
<tr>
<td style="text-align:left">OBJC_ASSOCIATION_COPY</td>
<td style="text-align:left">@property (copy, atomic)</td>
<td style="text-align:left">复制关联对象，且为原子操作</td>
</tr>
</tbody>
</table>
<p>再回到第2条看下怎么通过 <code>operationKey</code> 取消对应正在进行下载的操作（顺便附上加载图像的操作，因为两者正好始和末）：<br>代码：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置加载图像的操作</span></span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageLoadOperation:(<span class="keyword">nullable</span> <span class="keyword">id</span>&lt;SDWebImageOperation&gt;)operation forKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (key) &#123;</span><br><span class="line">        [<span class="keyword">self</span> sd_cancelImageLoadOperationWithKey:key];</span><br><span class="line">        <span class="keyword">if</span> (operation) &#123;</span><br><span class="line">            SDOperationsDictionary *operationDictionary = [<span class="keyword">self</span> sd_operationDictionary];</span><br><span class="line">            <span class="keyword">@synchronized</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">                [operationDictionary setObject:operation forKey:key];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//设置取消加载图像的操作</span></span><br><span class="line">- (<span class="keyword">void</span>)sd_cancelImageLoadOperationWithKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (key) &#123;</span><br><span class="line">        <span class="comment">// Cancel in progress downloader from queue</span></span><br><span class="line">        SDOperationsDictionary *operationDictionary = [<span class="keyword">self</span> sd_operationDictionary];</span><br><span class="line">        <span class="keyword">id</span>&lt;SDWebImageOperation&gt; operation;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">@synchronized</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">            operation = [operationDictionary objectForKey:key];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (operation) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([operation conformsToProtocol:<span class="class"><span class="keyword">@protocol</span>(<span class="title">SDWebImageOperation</span>)]) </span>&#123;</span><br><span class="line">                [operation cancel];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">@synchronized</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">                [operationDictionary removeObjectForKey:key];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>分析：<br><strong>首先</strong>，获取当前的一个 <code>NSMapTable</code> ，可以说是一个广义的字典，官方文档是这样解释 <code>NSMapTable</code> 的：</p>
<blockquote>
<p>An NSMapTable is modeled after a dictionary, although, because of its options, is not a dictionary because it will behave differently.  The major option is to have keys and/or values held “weakly” in a manner that entries will be removed at some indefinite point after one of the objects is reclaimed.  In addition to being held weakly, keys or values may be copied on input or may use pointer identity for equality and hashing.<br> An NSMapTable can also be configured to operate on arbitrary pointers and not just objects.We recommend the C function API for “void *” access</p>
</blockquote>
<p>大体可以理解为：<br> <code>NSMapTable</code> 是在字典之后的一个可变集合模型化的类，但由于它的选项是使 <code>key</code> 和/或 <code>valus</code> 保持“弱有化”，以便在回收其中一个对象之后在某个不确定点删除条目，所以它不是字典，因为它的行为会有所不同。 除了被弱化之外，可以在输入上复制 <code>key</code> 或 <code>valus</code>，或者可以使用指针标识来进行相等和 <code>hash</code>（散列or哈希）操作。<br> <code>NSMapTable</code> 也可以配置为对任意指针进行操作，而不仅仅是对象。 Apple建议使用C函数API进行 <code>void *</code> 访问。</p>
<p> SDWebImage是这样定义 <code>NSMapTable</code> 的：<br> <figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// key is copy, value is weak because operation<span class="built_in"> instance </span>is retained by SDWebImageManager's runningOperations property</span><br><span class="line">typedef NSMapTable&lt;NSString *, id&lt;SDWebImageOperation&gt;&gt; SDOperationsDictionary;</span><br></pre></td></tr></table></figure></p>
<p> key使用的是copy，value则使用的是weak，并给出了解释：操作实例由SDWebImageManager的runningOperations属性保留</p>
<p><strong>注：</strong>获取当前的 <code>NSMapTable</code> ，以下用 <code>operationDictionary</code> 叙述。</p>
<p> <strong>其次</strong>，将该图像的加载操作存放入 <code>operationDictionary</code> 中，而key正是我们上面分析的 <code>operationKey</code> 。这里为了防止在操作是被篡改，使用 <code>@synchronized</code> 做了互斥锁处理。</p>
<p> <strong>最后</strong>，现在再看取消加载图像的操作流程就显得清晰了，大体如下：</p>
<ol>
<li>获取当前的一个 <code>operationDictionary</code> 通过key取得操作。</li>
<li>如果该操作存在，就通过 <code>conformsToProtocol:@protocol()</code> 检查对象是否实现了指定协议类的方法。</li>
<li>如果存在就直接取消，最后从移除 <code>operationDictionary</code> 该操作</li>
</ol>
<p><strong>扩展：<code>objc_setAssociatedObject</code></strong></p>
<ul>
<li>在 Objective-C 中可以通过 Category 给一个现有的类添加属性，却不能添加实例变量，这成了 Objective-C 的一个明显短板。但可以通过 Associated Objects 来弥补这一不足。</li>
<li>相关函数：<br>与 Associated Objects 相关的函数主要有三个:<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">objc_setAssociatedObject</span>(<span class="params">id <span class="keyword">object</span>, <span class="keyword">const</span> <span class="keyword">void</span> *key, id <span class="keyword">value</span>, objc_AssociationPolicy policy</span>)</span>;</span><br><span class="line"><span class="function">id <span class="title">objc_getAssociatedObject</span>(<span class="params">id <span class="keyword">object</span>, <span class="keyword">const</span> <span class="keyword">void</span> *key</span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">objc_removeAssociatedObjects</span>(<span class="params">id <span class="keyword">object</span></span>)</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在使用是需要引入 <code>objc/runtime.h</code> 头文件</p>
<ul>
<li>函数的作用：<br>objc_setAssociatedObject 用于给对象添加关联对象，传入 nil 则可以移除已有的关联对象；<br>objc_getAssociatedObject 用于获取关联对象；<br>objc_removeAssociatedObjects 用于移除一个对象的所有关联对象。</li>
<li>key值使用：<br>推荐的方法大体有三种：<br>（1）声明 static char kAssociatedObjectKey; 使用 &amp;kAssociatedObjectKey 作为 key 值;<br>（2）声明 static void *kAssociatedObjectKey = &kAssociatedObjectKey; 使用 kAssociatedObjectKey 作为 key 值；<br>（3）用 selector ，使用 getter 方法的名称作为 key 值。</li>
</ul>
<p>我们看到的SDWebInage是使用的 <code>static char kAssociatedObjectKey</code> 这种方法。而 <code>static char</code> 这种声明是C语言的写法，意思是：声明一个局部静态变量。</p>
<p>附上一个讲的很不错的文章：<a href="http://blog.leichunfeng.com/blog/2015/06/26/objective-c-associated-objects-implementation-principle/" target="_blank" rel="noopener">Objective-C Associated Objects 的实现原理</a></p>
<h4 id="7-1-2、第二步"><a href="#7-1-2、第二步" class="headerlink" title="7.1.2、第二步"></a>7.1.2、第二步</h4><p>代码片段：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!(options &amp; SDWebImageDelayPlaceholder)) &#123;</span><br><span class="line">        dispatch_main_async_safe(^&#123;</span><br><span class="line">            [self <span class="string">sd_setImage:</span>placeholder <span class="string">imageData:</span>nil <span class="string">basedOnClassOrViaCustomSetImageBlock:</span>setImageBlock];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>解析：<br>条件语句判断options选项是否为 <code>SDWebImageDelayPlaceholder</code> 若不是则执行条件语句里的内容。（条件语句中执行的是设置占位符图像，但该选项是延迟占位符加载，所以需要加以判断。）</p>
<p><code>dispatch_main_async_safe(^{})</code> 宏定义主线程异步安全加载，如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> dispatch_main_async_safe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dispatch_main_async_safe(block) dispatch_queue_async_safe(dispatch_get_main_queue(), block)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> dispatch_queue_async_safe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dispatch_queue_async_safe(queue, block)\</span></span><br><span class="line">    <span class="keyword">if</span> (dispatch_queue_get_label(DISPATCH_CURRENT_QUEUE_LABEL) == dispatch_queue_get_label(<span class="built_in">queue</span>)) &#123;\</span><br><span class="line">        block();\</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;\</span><br><span class="line">        dispatch_async(<span class="built_in">queue</span>, block);\</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>dispatch_main_async_safe</code> 安全的分发任务到主线程里面运行<br><code>dispatch_queue_get_label</code> 用来取队列的名字，进而判断如果当前已经是主队列，那么直接执行，否则回调到主队列之后再执行。</p>
<p>原因是：如果当前队列已经是主队列，那么再调用 <code>dispatch_async(dispatch_get_main_queue(), block)</code>有可能会出现<code>crash</code>。而该方法则很好的做了预防工作。</p>
<p>下面看条件语句中的执行方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sd_setImage:(<span class="built_in">UIImage</span> *)image imageData:(<span class="built_in">NSData</span> *)imageData basedOnClassOrViaCustomSetImageBlock:(SDSetImageBlock)setImageBlock &#123;</span><br><span class="line"><span class="meta">#if SD_UIKIT || SD_MAC</span></span><br><span class="line">    [<span class="keyword">self</span> sd_setImage:image imageData:imageData basedOnClassOrViaCustomSetImageBlock:setImageBlock transition:<span class="literal">nil</span> cacheType:<span class="number">0</span> imageURL:<span class="literal">nil</span>];</span><br><span class="line"><span class="meta">#else</span></span><br><span class="line">    <span class="comment">// watchOS does not support view transition. Simplify the logic</span></span><br><span class="line">    <span class="keyword">if</span> (setImageBlock) &#123;</span><br><span class="line">        setImageBlock(image, imageData);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span> isKindOfClass:[<span class="built_in">UIImageView</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">UIImageView</span> *imageView = (<span class="built_in">UIImageView</span> *)<span class="keyword">self</span>;</span><br><span class="line">        [imageView setImage:image];</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该方法目的为了执行加载占位符图像。分了两种情况 <code>iOS和VTOS 、masOS系统</code> 和 其他。分类型的原因 <code>SDWebImage</code> 给了简单说明： <code>watchOS</code> 不支持 <code>view</code> 的翻转动画，所以 <code>SDWebImage</code> 做了一个简单的加载显示处理。而其他类型则和图像URL的加载显示共用了一套方法（具体实现在加载URL图像时细看）。<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- <span class="params">(void)</span>sd_setImage:<span class="params">(UIImage *)</span>image imageData:<span class="params">(NSData *)</span>imageData basedOnClassOrViaCustomSetImageBlock:<span class="params">(SDSetImageBlock)</span>setImageBlock transition:<span class="params">(SDWebImageTransition *)</span>transition cacheType:<span class="params">(SDImageCacheType)</span>cacheType imageURL:<span class="params">(NSURL *)</span>imageURL</span><br></pre></td></tr></table></figure></p>
<h4 id="7-1-3、第三步-正式准备加载URL图像"><a href="#7-1-3、第三步-正式准备加载URL图像" class="headerlink" title="7.1.3、第三步 正式准备加载URL图像"></a>7.1.3、第三步 正式准备加载URL图像</h4><p>同样分两种情况，根据所传的 <code>url</code> 是否存在做区分</p>
<ol>
<li><strong><code>url</code> 不存在情况</strong><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">        dispatch_main_async_safe(^&#123;</span><br><span class="line"><span class="meta">#if SD_UIKIT</span></span><br><span class="line">            [self sd_removeActivityIndicator];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">if</span> (completedBlock) &#123;</span><br><span class="line">                NSError *<span class="built_in">error</span> = [NSError errorWithDomain:SDWebImageErrorDomain <span class="built_in">code</span>:<span class="number">-1</span> userInfo:<span class="comment">@&#123;NSLocalizedDescriptionKey : @</span><span class="string">"Trying to load a nil url"</span>&#125;];</span><br><span class="line">                completedBlock(nil, <span class="built_in">error</span>, SDImageCacheTypeNone, url);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>分析：<br>首先确保在线程安全的情况下，如果<code>iOS和VTOS系统</code>就做下移除<strong>加载指示器</strong>操作。<br>如果<code>completedBlock</code>代码块存在，就获取错误信息，执行回调内的操作。<br><code>SDExternalCompletionBlock</code> 的声明:<br><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef void(^<span class="type">SDExternalCompletionBlock</span>)(<span class="type">UIImage</span> * _Nullable image, <span class="type">NSError</span> * _Nullable error, <span class="type">SDImageCacheType</span> cacheType, <span class="type">NSURL</span> * _Nullable imageURL);</span><br></pre></td></tr></table></figure></p>
<p>下面是url传nil时的情况：<br><img src="http://obzx0h1re.bkt.clouddn.com/SDWebImage_Error.jpg" alt="SDWebImage_Error"></p>
<ol start="2">
<li><strong><code>url</code> 存在情况</strong></li>
</ol>
<ul>
<li>1、如果是<code>iOS和VTOS</code>的系统，则判断使用显示加载指示器，如果显示则创建并添加到View上。<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#if SD_UIKIT</span></span><br><span class="line">        //<span class="built_in"> check </span>if activityView is enabled<span class="built_in"> or </span>not</span><br><span class="line">       <span class="built_in"> if </span>([self sd_showActivityIndicatorView]) &#123;</span><br><span class="line">            [self sd_addActivityIndicator];</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">#endif</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>配置加载指示器：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[self.customImageView sd_setShowActivityIndicatorView:YES]</span><span class="comment">;</span></span><br><span class="line"><span class="section">[self.customImageView sd_setIndicatorStyle:UIActivityIndicatorViewStyleGray]</span><span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>2、根据上下文获取 <code>SDWebImageManager</code></li>
</ul>
<p>根据上下文（<code>context</code>）获取 <code>SDWebImageManager</code>，没有则创建。<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SDWebImageManager *manager<span class="comment">;</span></span><br><span class="line">if ([<span class="built_in">context</span> valueForKey:SDWebImageExternalCustomManagerKey]) &#123;</span><br><span class="line">    manager = (SDWebImageManager *)[<span class="built_in">context</span> valueForKey:SDWebImageExternalCustomManagerKey]<span class="comment">;</span></span><br><span class="line">&#125; else &#123;</span><br><span class="line">    manager = [SDWebImageManager <span class="keyword">sharedManager];</span></span><br><span class="line"><span class="keyword">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p><code>SDWebImageManager</code>是 <code>SDWebImage</code> 管理以及操作的类。该类是<code>SDWebImage</code>的核心类，拥有一个SDWebImageCache 和 SDWebImageDownloader 属性，分别用于图片缓存和下载处理。</p>
<p>关于 <code>SDWebImageManager</code> 这里不细说，分出去单独研究。</p>
<ul>
<li>3 加载进度回调（或者说加载进度回调中…）</li>
</ul>
<p>下载图像时重复调用该代码块，在后台队列上执行。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reset the progress</span></span><br><span class="line"><span class="keyword">self</span>.sd_imageProgress.totalUnitCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">self</span>.sd_imageProgress.completedUnitCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">__<span class="keyword">weak</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>)wself = <span class="keyword">self</span>;</span><br><span class="line">SDWebImageDownloaderProgressBlock combinedProgressBlock = ^(<span class="built_in">NSInteger</span> receivedSize, <span class="built_in">NSInteger</span> expectedSize, <span class="built_in">NSURL</span> * _Nullable targetURL) &#123;</span><br><span class="line">    wself.sd_imageProgress.totalUnitCount = expectedSize;</span><br><span class="line">    wself.sd_imageProgress.completedUnitCount = receivedSize;</span><br><span class="line">    <span class="keyword">if</span> (progressBlock) &#123;</span><br><span class="line">        progressBlock(receivedSize, expectedSize, targetURL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>代码块中会判断传入的 <code>progressBlock</code> 是否为空，不为空的话执行回调操作，回调方法中开发者可以处理一些其他操作。看下图：</p>
<p><img src="http://obzx0h1re.bkt.clouddn.com/SDWebImage_progressBlock.jpg" alt="SDWebImage_progressBlock"></p>
<h4 id="7-1-4、第四步-加载URL图像"><a href="#7-1-4、第四步-加载URL图像" class="headerlink" title="7.1.4、第四步 加载URL图像"></a>7.1.4、第四步 加载URL图像</h4><p>加载图像的代码比较多，接下来就在代码中加注释分析。<br>加载图像的方法是在 <code>SDWebImageManager</code>类中完成的，这里只是执行加载完成后的代码块中的内容。<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- <span class="params">(id &lt;SDWebImageOperation&gt;)</span>loadImageWithURL:<span class="params">(nullable NSURL *)</span>url</span><br><span class="line">                                     options:<span class="params">(SDWebImageOptions)</span>options</span><br><span class="line">                                    progress:<span class="params">(nullable SDWebImageDownloaderProgressBlock)</span>progressBlock</span><br><span class="line">                                   completed:<span class="params">(nullable SDInternalCompletionBlock)</span>completedBlock</span><br></pre></td></tr></table></figure></p>
<p>加载图像的过程先不去考虑，先看加载完成后的代码块中执行的内容：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> &lt;SDWebImageOperation&gt; operation = [manager loadImageWithURL:url options:options progress:combinedProgressBlock completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSData</span> *data, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">BOOL</span> finished, <span class="built_in">NSURL</span> *imageURL) &#123;</span><br><span class="line">        </span><br><span class="line">    __<span class="keyword">strong</span> __<span class="keyword">typeof</span> (wself) sself = wself; <span class="comment">//代码块中创建强引用</span></span><br><span class="line">    <span class="keyword">if</span> (!sself) &#123; <span class="keyword">return</span>; &#125; <span class="comment">//如果强引用的self不存在，退出block</span></span><br><span class="line"><span class="meta">#if SD_UIKIT</span></span><br><span class="line">    [sself sd_removeActivityIndicator]; <span class="comment">//不是iOS and tvOS系统的话，移除加载指示器</span></span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    <span class="comment">// if the progress not been updated, mark it to complete state （如果进度未更新，请将其标记为完成状态）</span></span><br><span class="line">    <span class="keyword">if</span> (finished &amp;&amp; !error &amp;&amp; sself.sd_imageProgress.totalUnitCount == <span class="number">0</span> &amp;&amp; sself.sd_imageProgress.completedUnitCount == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//如果加载结束、没错误、sd_imageProgress.totalUnitCount 和 sd_imageProgress.completedUnitCount 都为0，则设置两者的值为未知值</span></span><br><span class="line">        sself.sd_imageProgress.totalUnitCount = SDWebImageProgressUnitCountUnknown;</span><br><span class="line">        sself.sd_imageProgress.completedUnitCount = SDWebImageProgressUnitCountUnknown;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   是否应该回调CompletedBlock （ 加载完成 或者 传入的 options 选项 为 SDWebImageAvoidAutoSetImage）</span><br><span class="line">    <span class="built_in">BOOL</span> shouldCallCompletedBlock = finished || (options &amp; SDWebImageAvoidAutoSetImage);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//判断是否应该不设置Image （如果有图片但设置了SDWebImageAvoidAutoSetImage 或者没有图片并且没有设置SDWebImageDelayPlaceholder）</span></span><br><span class="line">    <span class="built_in">BOOL</span> shouldNotSetImage = ((image &amp;&amp; (options &amp; SDWebImageAvoidAutoSetImage)) ||</span><br><span class="line">                              (!image &amp;&amp; !(options &amp; SDWebImageDelayPlaceholder)));</span><br><span class="line">                              </span><br><span class="line">    SDWebImageNoParamsBlock callCompletedBlockClojure = ^&#123;</span><br><span class="line">        <span class="comment">//如果view不存在，终止执行</span></span><br><span class="line">        <span class="keyword">if</span> (!sself) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        需要设置Image，就刷新视图</span><br><span class="line">        <span class="keyword">if</span> (!shouldNotSetImage) &#123;</span><br><span class="line">            [sself sd_setNeedsLayout];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//如果传入了completedBlock并且应该回调，则执行回调</span></span><br><span class="line">        <span class="keyword">if</span> (completedBlock &amp;&amp; shouldCallCompletedBlock) &#123;</span><br><span class="line">        <span class="comment">//回调</span></span><br><span class="line">            completedBlock(image, error, cacheType, url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// case 1a: we got an image, but the SDWebImageAvoidAutoSetImage flag is set （我们得到了一个图像，但设置了SDWebImageAvoidAutoSetImage标志）</span></span><br><span class="line">    <span class="comment">// OR</span></span><br><span class="line">    <span class="comment">// case 1b: we got no image and the SDWebImageDelayPlaceholder is not set（我们没有图像，并且没有设置SDWebImageDelayPlaceholder标志）</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment">//如果不需要设置图片就在主线程队列种调用上面生成的完成回调代码块，然后停止执行</span></span><br><span class="line">    <span class="keyword">if</span> (shouldNotSetImage) &#123;</span><br><span class="line">        dispatch_main_async_safe(callCompletedBlockClojure);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初始化变量</span></span><br><span class="line">    <span class="built_in">UIImage</span> *targetImage = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSData</span> *targetData = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (image) &#123;</span><br><span class="line">        <span class="comment">// case 2a: we got an image and the SDWebImageAvoidAutoSetImage is not set （我们得到了一个图像，并且没有设置SDWebImageAvoidAutoSetImage）</span></span><br><span class="line">        <span class="comment">//如果图片下载成功就将其保存到变量中</span></span><br><span class="line">        targetImage = image;</span><br><span class="line">        targetData = data;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options &amp; SDWebImageDelayPlaceholder) &#123;</span><br><span class="line">        <span class="comment">// case 2b: we got no image and the SDWebImageDelayPlaceholder flag is set（我们没有图像，并且设置了SDWebImage Delay Placeholder标志）</span></span><br><span class="line">        如果图片下载失败并且设置了延迟加载占位符图像，就保存占位符图像</span><br><span class="line">        targetImage = placeholder;</span><br><span class="line">        targetData = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">            </span><br><span class="line"><span class="meta">#if SD_UIKIT || SD_MAC （iOS and tvOS macOS）</span></span><br><span class="line">    <span class="comment">// check whether we should use the image transition（检查我们是否应该使用图像过渡转换）</span></span><br><span class="line">    SDWebImageTransition *transition = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">//如果加载结束并且options选项为：SDWebImageForceTransition 或者 缓存类型为：SDImageCacheTypeNone</span></span><br><span class="line">    <span class="keyword">if</span> (finished &amp;&amp; (options &amp; SDWebImageForceTransition || cacheType == SDImageCacheTypeNone)) &#123;</span><br><span class="line">    <span class="comment">//保存图像过渡转换</span></span><br><span class="line">        transition = sself.sd_imageTransition;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">    dispatch_main_async_safe(^&#123;</span><br><span class="line">    <span class="comment">//主线程队列种设置图像</span></span><br><span class="line"><span class="meta">#if SD_UIKIT || SD_MAC （iOS and tvOS macOS）</span></span><br><span class="line">            设置图像</span><br><span class="line">            [sself sd_setImage:targetImage imageData:targetData basedOnClassOrViaCustomSetImageBlock:setImageBlock transition:transition cacheType:cacheType imageURL:imageURL];</span><br><span class="line"><span class="meta">#else</span></span><br><span class="line">            <span class="comment">//iWatchOS系统设置图像</span></span><br><span class="line">            [sself sd_setImage:targetImage imageData:targetData basedOnClassOrViaCustomSetImageBlock:setImageBlock];</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">            <span class="comment">//设置完成后调用完成回调代码块</span></span><br><span class="line">            callCompletedBlockClojure();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="comment">//SDOperationsDictionary存储当前的操作。</span></span><br><span class="line">    [<span class="keyword">self</span> sd_setImageLoadOperation:operation forKey:validOperationKey];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面再使用纯描述的方式，过一遍流程：（为了简便，以下：<code>SD_UIKIT || SD_MAC</code> 简称：<code>iOS_tvOS_MAC</code>; <code>SD_MAC</code>简称：<code>MAC</code>  <code>SD_UIKIT</code> 简称 ：<code>iOS_tvOS</code>）</p>
<p><code>__strong</code>在<code>Block</code>内部修饰的对象,会保证,在使用这个对象在block内,这个对象都不会被释放。</p>
<p>之前分析过，加载指示器只能在<code>iOS_tvOS</code>的情况下添加，所以加载完成后需要移除。如下：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SD_UIKIT</span></span><br><span class="line">            [<span class="meta">sself sd_removeActivityIndicator</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<p>如果加载已经完成并且没有错误；iamge进度的总单元和完成单元都是0，就设置<code>imageProgress</code> 的总单元和完成单元值为未知。</p>
<p>创建 “应该执行完成加载的回调” 和 “不应该设置Image” 两个布尔值。<br><code>SDWebImageAvoidAutoSetImage</code>: 在设置图像之前手动处理一些东西（例如应用滤镜或添加交叉渐变动画）请使用此标志<br><code>SDWebImageDelayPlaceholder</code> : 延迟显示占位符图像</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//加载完成 或者 传入的 options 选项为 SDWebImageAvoidAutoSetImage</span></span><br><span class="line">BOOL shouldCallCompletedBlock = finished <span class="string">|| (options &amp; SDWebImageAvoidAutoSetImage);</span></span><br><span class="line"><span class="comment">//图片存在并且选项为 SDWebImageAvoidAutoSetImage 或者 图片不存在并且选项不为SDWebImageDelayPlaceholder</span></span><br><span class="line">BOOL shouldNotSetImage = ((image <span class="meta">&amp;&amp; (options &amp; SDWebImageAvoidAutoSetImage)) ||</span></span><br><span class="line">                                    (!image <span class="meta">&amp;&amp; !(options &amp; SDWebImageDelayPlaceholder)));</span></span><br></pre></td></tr></table></figure>
<p><code>SDWebImageNoParamsBlock</code> 回调<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SDWebImageNoParamsBlock callCompletedBlockClojure = ^&#123;</span><br><span class="line">                <span class="keyword">if</span> (!sself) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">                <span class="keyword">if</span> (!shouldNotSetImage) &#123;</span><br><span class="line">                    <span class="comment">//需要设置Image</span></span><br><span class="line">                    [sself sd_setNeedsLayout];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//completedBlock存在并且需要回调</span></span><br><span class="line">                <span class="keyword">if</span> (completedBlock &amp;&amp; shouldCallCompletedBlock) &#123;</span><br><span class="line">                    completedBlock(<span class="keyword">image</span>, <span class="keyword">error</span>, cacheType, url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br></pre></td></tr></table></figure></p>
<p>不需要设置Image，执行callCompletedBlockClojure回调代码<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (shouldNotSetImage) &#123;</span><br><span class="line">     dispatch_main_async_safe(callCompletedBlockClojure);</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>图像和图像Data赋值：<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UIImage</span> *targetImage = <span class="keyword">nil</span>;</span><br><span class="line"><span class="type">NSData</span> *targetData = <span class="keyword">nil</span>;</span><br><span class="line"><span class="keyword">if</span> (image) &#123;</span><br><span class="line">    // <span class="keyword">case</span> <span class="number">2</span>a: we got an image <span class="keyword">and</span> the <span class="type">SDWebImageAvoidAutoSetImage</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="built_in">set</span></span><br><span class="line">    targetImage = image;</span><br><span class="line">    targetData = data;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (options &amp; <span class="type">SDWebImageDelayPlaceholder</span>) &#123;</span><br><span class="line">    // <span class="keyword">case</span> <span class="number">2</span>b: we got no image <span class="keyword">and</span> the <span class="type">SDWebImageDelayPlaceholder</span> flag <span class="keyword">is</span> <span class="built_in">set</span></span><br><span class="line">    targetImage = placeholder;</span><br><span class="line">    targetData = <span class="keyword">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果系统类型为：<code>iOS_tvOS_MAC</code>，图像过渡动画赋值<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#if SD_UIKIT || SD_MAC</span></span><br><span class="line">    //<span class="built_in"> check </span>whether we should use the image transition</span><br><span class="line">    SDWebImageTransition *transition = nil;</span><br><span class="line">   <span class="built_in"> if </span>(finished &amp;&amp; (options &amp; SDWebImageForceTransition || cacheType == SDImageCacheTypeNone)) &#123;</span><br><span class="line">        transition = sself.sd_imageTransition;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#endif</span></span><br></pre></td></tr></table></figure></p>
<p>执行异步安全加载，根据不同的系统执行不同的方法。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">dispatch_main_async_safe(^&#123;</span></span><br><span class="line"><span class="comment">#if SD_UIKIT || SD_MAC</span></span><br><span class="line">                <span class="string">[sself</span> <span class="attr">sd_setImage:targetImage</span> <span class="attr">imageData:targetData</span> <span class="attr">basedOnClassOrViaCustomSetImageBlock:setImageBlock</span> <span class="attr">transition:transition</span> <span class="attr">cacheType:cacheType</span> <span class="attr">imageURL:imageURL];</span></span><br><span class="line"><span class="comment">#else</span></span><br><span class="line">                <span class="string">[sself</span> <span class="attr">sd_setImage:targetImage</span> <span class="attr">imageData:targetData</span> <span class="attr">basedOnClassOrViaCustomSetImageBlock:setImageBlock];</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">                <span class="string">callCompletedBlockClojure();</span></span><br><span class="line">            <span class="string">&#125;);</span></span><br><span class="line">        <span class="string">&#125;];</span></span><br></pre></td></tr></table></figure></p>
<p>以上就是大体加载图像所展示的流程</p>
<p>接下来看一下需要动画翻转过渡的代码（可以使用动画过渡的是<code>iOS_tvOS_MAC</code>）<br>其实就是多加了一个转换动画的执行代码。其他的就是UIImageView和UIButton 的图像设置。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#if SD_UIKIT || SD_MAC</span></span><br><span class="line">- (<span class="keyword">void</span>)sd_setImage:(<span class="built_in">UIImage</span> *)image imageData:(<span class="built_in">NSData</span> *)imageData basedOnClassOrViaCustomSetImageBlock:(SDSetImageBlock)setImageBlock transition:(SDWebImageTransition *)transition cacheType:(SDImageCacheType)cacheType imageURL:(<span class="built_in">NSURL</span> *)imageURL &#123;</span><br><span class="line">    <span class="built_in">UIView</span> *view = <span class="keyword">self</span>;</span><br><span class="line">    <span class="comment">//最终的图像设置block</span></span><br><span class="line">    SDSetImageBlock finalSetImageBlock;</span><br><span class="line">    <span class="comment">//若setImageBlock，说明是Button需要自定义图像。</span></span><br><span class="line">    <span class="keyword">if</span> (setImageBlock) &#123;</span><br><span class="line">        finalSetImageBlock = setImageBlock;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([view isKindOfClass:[<span class="built_in">UIImageView</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">    <span class="comment">//若View为ImageView，执行block回调，为imageView赋值</span></span><br><span class="line">        <span class="built_in">UIImageView</span> *imageView = (<span class="built_in">UIImageView</span> *)view;</span><br><span class="line">        finalSetImageBlock = ^(<span class="built_in">UIImage</span> *setImage, <span class="built_in">NSData</span> *setImageData) &#123;</span><br><span class="line">            imageView.image = setImage;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#if SD_UIKIT</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ([view isKindOfClass:[<span class="built_in">UIButton</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">     <span class="comment">//若View为button，执行block回调，为button赋值</span></span><br><span class="line">        <span class="built_in">UIButton</span> *button = (<span class="built_in">UIButton</span> *)view;</span><br><span class="line">        finalSetImageBlock = ^(<span class="built_in">UIImage</span> *setImage, <span class="built_in">NSData</span> *setImageData)&#123;</span><br><span class="line">            [button setImage:setImage forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//动画过渡执行代码</span></span><br><span class="line">    <span class="keyword">if</span> (transition) &#123;</span><br><span class="line"><span class="meta">#if SD_UIKIT</span></span><br><span class="line">        [<span class="built_in">UIView</span> transitionWithView:view duration:<span class="number">0</span> options:<span class="number">0</span> animations:^&#123;</span><br><span class="line">            <span class="comment">// 0 duration to let UIKit render placeholder and prepares block</span></span><br><span class="line">            <span class="keyword">if</span> (transition.prepares) &#123;</span><br><span class="line">                transition.prepares(view, image, imageData, cacheType, imageURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; completion:^(<span class="built_in">BOOL</span> finished) &#123;</span><br><span class="line">            [<span class="built_in">UIView</span> transitionWithView:view duration:transition.duration options:transition.animationOptions animations:^&#123;</span><br><span class="line">                <span class="keyword">if</span> (finalSetImageBlock &amp;&amp; !transition.avoidAutoSetImage) &#123;</span><br><span class="line">                    finalSetImageBlock(image, imageData);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (transition.animations) &#123;</span><br><span class="line">                    transition.animations(view, image);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; completion:transition.completion];</span><br><span class="line">        &#125;];</span><br><span class="line"><span class="meta">#elif SD_MAC</span></span><br><span class="line">        [<span class="built_in">NSAnimationContext</span> runAnimationGroup:^(<span class="built_in">NSAnimationContext</span> * _Nonnull prepareContext) &#123;</span><br><span class="line">            <span class="comment">// 0 duration to let AppKit render placeholder and prepares block</span></span><br><span class="line">            prepareContext.duration = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (transition.prepares) &#123;</span><br><span class="line">                transition.prepares(view, image, imageData, cacheType, imageURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; completionHandler:^&#123;</span><br><span class="line">            [<span class="built_in">NSAnimationContext</span> runAnimationGroup:^(<span class="built_in">NSAnimationContext</span> * _Nonnull context) &#123;</span><br><span class="line">                context.duration = transition.duration;</span><br><span class="line">                context.timingFunction = transition.timingFunction;</span><br><span class="line">                context.allowsImplicitAnimation = (transition.animationOptions &amp; SDWebImageAnimationOptionAllowsImplicitAnimation);</span><br><span class="line">                <span class="keyword">if</span> (finalSetImageBlock &amp;&amp; !transition.avoidAutoSetImage) &#123;</span><br><span class="line">                    finalSetImageBlock(image, imageData);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (transition.animations) &#123;</span><br><span class="line">                    transition.animations(view, image);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; completionHandler:^&#123;</span><br><span class="line">                <span class="keyword">if</span> (transition.completion) &#123;</span><br><span class="line">                    transition.completion(<span class="literal">YES</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125;];</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (finalSetImageBlock) &#123;</span><br><span class="line">            finalSetImageBlock(image, imageData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure>
<p>以上就是 <code>SDWebImage</code> 设置图片的整个流程，但只是过了一遍代码而已，内部的实现并没有深入，例如：<code>SDWebImage</code> 的下载、缓存机制。这些都没有深入去了解。</p>
</div><div class="tags"><a href="/tags/SDWebImage/">SDWebImage</a></div><div class="post-nav"><a class="pre" href="/2018/10/01/Read-SDWebImage-SDWebImageManager/">读SDWebImage 二 (SDWebImageManager)</a><a class="next" href="/2018/06/30/copyAndMutableCopy/">copy 和 mutableCopy</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://guohuaden.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/SVN/">SVN</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Swift/">Swift</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Xcode/">Xcode</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/欠下的时光/">欠下的时光</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/项目总结/">项目总结</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/毛玻璃效果/" style="font-size: 15px;">毛玻璃效果</a> <a href="/tags/Xcode/" style="font-size: 15px;">Xcode</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/SDWebImage/" style="font-size: 15px;">SDWebImage</a> <a href="/tags/SVN/" style="font-size: 15px;">SVN</a> <a href="/tags/自定义的搜索框/" style="font-size: 15px;">自定义的搜索框</a> <a href="/tags/常用的标记/" style="font-size: 15px;">常用的标记</a> <a href="/tags/统计代码量/" style="font-size: 15px;">统计代码量</a> <a href="/tags/欠下的时光/" style="font-size: 15px;">欠下的时光</a> <a href="/tags/加解密/" style="font-size: 15px;">加解密</a> <a href="/tags/毛玻璃效果，虚化效果/" style="font-size: 15px;">毛玻璃效果，虚化效果</a> <a href="/tags/WKWebView/" style="font-size: 15px;">WKWebView</a> <a href="/tags/WebView/" style="font-size: 15px;">WebView</a> <a href="/tags/模拟器错误/" style="font-size: 15px;">模拟器错误</a> <a href="/tags/block-weak/" style="font-size: 15px;">block,weak</a> <a href="/tags/copy-mutableCopy/" style="font-size: 15px;">copy, mutableCopy</a> <a href="/tags/文件加密/" style="font-size: 15px;">文件加密</a> <a href="/tags/关于app支持64bit-iOS/" style="font-size: 15px;">关于app支持64bit,iOS</a> <a href="/tags/bridge和Core-Foundation/" style="font-size: 15px;">bridge和Core Foundation</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/10/24/Read-SDWebImage-SDWebImageDownloaderOperation/">读 SDWebImage 五 （SDWebImageDownloaderOperation）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/04/Read-SDWebImage-SDWebImageDownloader/">读 SDWebImage 四 (SDWebImageDownloader)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/02/Read-SDWebImage-SDImageCache/">读 SDWebImage 三 (SDImageCache)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/01/Read-SDWebImage-SDWebImageManager/">读SDWebImage 二 (SDWebImageManager)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/29/Read-SDWebImage-note1/">读 SDWebImage 一 使用分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/30/copyAndMutableCopy/">copy 和 mutableCopy</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/03/Project-summary-Four/">项目总结四</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/05/project-summary-Three/">iOS之项目总结三：项目开发中遇到的一些问题及解决方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/03/WKWebView-issue/">WKWebView使用遇到的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/20/GH-SearchView/">一个自定义的搜索框：GH_SearchView</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/Wheat-Qin" title="github" target="_blank">github</a><ul></ul><a href="wheatden@guohuaden.com" title="email" target="_blank">email</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">喂、三二一
</a>Motto：灾难总是接踵而至，这正是世间的常理。只要找个理由，就会有谁来救你吗？要是死了，就只是说明我不过是如此程度的男人.+'\n'
Email：guohua@guohuaden.com</div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>