<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>watchdog | 所念皆星辰 | 踏实、低调、前行。</title>

  
  <meta name="author" content="Wheat">
  

  
  <meta name="description" content="简单的一个技术博客，用来作为学习笔记和日常记录使用。">
  

  
  
  <meta name="keywords" content="watchdog">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="watchdog"/>

  <meta property="og:site_name" content="所念皆星辰"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="所念皆星辰" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">所念皆星辰</a>
    </h1>
    <p class="site-description">踏实、低调、前行。</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>watchdog</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/07/07/watchdog/" rel="bookmark">
        <time class="entry-date published" datetime="2020-07-07T14:44:50.000Z">
          2020-07-07
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>为了防止一个应用程序占用过多的系统资源，苹果设计一个监督机构 <code>watchdog</code> ,音译：<strong>看门狗机制。</strong></p>
<p>用户希望应用程序快速启动，并对触摸和手势做出响应。操作系统使用一个监督机构来监控启动时间和应用程序的响应，如果超出了该场景下所规定的运行时间，该机制就会终止无响应的应用程序。</p>
<p><code>watchdog</code> 完整的信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Exception Type:  EXC_CRASH (SIGKILL)</span><br><span class="line">Exception Codes: 0x0000000000000000, 0x0000000000000000</span><br><span class="line">Exception Note:  EXC_CORPSE_NOTIFY</span><br><span class="line">Termination Reason: Namespace SPRINGBOARD, Code 0x8badf00d</span><br><span class="line">Termination Description: SPRINGBOARD, &lt;RBSTerminateContext| domain:10 code:0x8BADF00D explanation:scene-update watchdog transgression: application&lt;com.kaike.online&gt;:745 exhausted real (wall clock) time allowance of 10.00 seconds | ProcessVisibility: Background | ProcessState: Running | WatchdogEvent: scene-update | WatchdogVisibility: Background | WatchdogCPUStatistics: ( | &quot;Elapsed total CPU time (seconds): 20.230 (user 20.230, system 0.000), 34% CPU&quot;, | &quot;Elapsed application CPU time (seconds): 0.001, 0% CPU&quot; | ) reportType:CrashLog maxTerminationResistance:Interactive&gt;</span><br><span class="line">Triggered by Thread:  0</span><br></pre></td></tr></table></figure>
<p>通俗讲：</p>
<p>为了避免应用陷入错误状态导致界面无响应，Apple 设计了 <code>watchdog</code> 机制。一旦超时，强制杀死进程。在不同的生命周期，触发 <code>watchdog</code> 机制的超时时间有所不同：</p>
<table>
<thead>
<tr>
<th style="text-align:center">生命周期</th>
<th style="text-align:center">超时时间</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">启动 Launch</td>
<td style="text-align:center">20s</td>
</tr>
<tr>
<td style="text-align:center">恢复 Resume</td>
<td style="text-align:center">10s</td>
</tr>
<tr>
<td style="text-align:center">悬挂 Suspend</td>
<td style="text-align:center">10s</td>
</tr>
<tr>
<td style="text-align:center">退出Quit</td>
<td style="text-align:center">6s</td>
</tr>
<tr>
<td style="text-align:center">后台 Background</td>
<td style="text-align:center">10min</td>
</tr>
</tbody>
</table>
<p><code>watchdog</code> 的终止使用崩溃报告的终止原因中的代码是 <code>0x8badf00d</code> （发音为“吃了不好的食物”）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Exception Type:  EXC_CRASH (SIGKILL)</span><br><span class="line">Exception Codes: 0x0000000000000000, 0x0000000000000000</span><br><span class="line">Exception Note:  EXC_CORPSE_NOTIFY</span><br><span class="line">Termination Reason: Namespace SPRINGBOARD, Code 0x8badf00d</span><br></pre></td></tr></table></figure>
<p><code>watchdog</code> 终止长时间阻塞主线程的应用程序。有很多方法可以延长阻塞主线程，例如：</p>
<ul>
<li>同步网络</li>
<li><p>处理大量数据</p>
</li>
<li><p>同步触发大型核心数据存储的轻量级迁移</p>
</li>
<li>使用Vision进行分析请求。</li>
</ul>
<h3 id="解读App响应式-watchdog-信息"><a href="#解读App响应式-watchdog-信息" class="headerlink" title="解读App响应式 watchdog 信息"></a>解读App响应式 <code>watchdog</code> 信息</h3><p>当应用程序启动或响应事件缓慢时，崩溃报告中的终止信息包含有关应用程序如何花费时间的重要信息。</p>
<h4 id="崩溃信息一"><a href="#崩溃信息一" class="headerlink" title="崩溃信息一"></a>崩溃信息一</h4><p>例如，卡顿时挂起App在崩溃报告中具有以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Termination Description: SPRINGBOARD, &lt;RBSTerminateContext| domain:10 code:0x8BADF00D explanation:scene-update watchdog transgression: application&lt;com.example.MyCoolApp&gt;:745 exhausted real (wall clock) time allowance of 10.00 seconds </span><br><span class="line">    | ProcessVisibility: Background </span><br><span class="line">    | ProcessState: Running </span><br><span class="line">    | WatchdogEvent: scene-update </span><br><span class="line">    | WatchdogVisibility: Background </span><br><span class="line">    | WatchdogCPUStatistics: ( </span><br><span class="line">    | &quot;Elapsed total CPU time (seconds): 20.230 (user 20.230, system 0.000), 34% CPU&quot;, </span><br><span class="line">    | &quot;Elapsed application CPU time (seconds): 0.001, 0% CPU&quot; </span><br><span class="line">    | )</span><br></pre></td></tr></table></figure>
<p>上述描述中可以看出：<code>WatchdogEvent</code> 是 <code>scene-update</code> ，说明应用程序是在<strong>场景更新</strong> 时终止的，原因是没有足够快地更新其UI，因为主线程太忙。</p>
<h4 id="崩溃信息二"><a href="#崩溃信息二" class="headerlink" title="崩溃信息二"></a>崩溃信息二</h4><p>在App启动后没有快速呈现UI，在崩溃报告中具有以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Termination Description: SPRINGBOARD, </span><br><span class="line">    scene-create watchdog transgression: application&lt;com.example.MyCoolApp&gt;:667</span><br><span class="line">    exhausted real (wall clock) time allowance of 19.97 seconds </span><br><span class="line">    | ProcessVisibility: Foreground </span><br><span class="line">    | ProcessState: Running </span><br><span class="line">    | WatchdogEvent: scene-create </span><br><span class="line">    | WatchdogVisibility: Foreground </span><br><span class="line">    | WatchdogCPUStatistics: ( </span><br><span class="line">    |  &quot;Elapsed total CPU time (seconds): 15.290 (user 15.290, system 0.000), 28% CPU&quot;, </span><br><span class="line">    |  &quot;Elapsed application CPU time (seconds): 0.367, 1% CPU&quot; </span><br><span class="line">    | )</span><br></pre></td></tr></table></figure>
<p>由<code>WatchdogEvent: scene-create</code> 可以看出是在<strong>场景创建</strong>时终止的，原因是没有在允许的启动时间内将UI的第一帧渲染到屏幕上。</p>
<h4 id="崩溃信息中的信息解析"><a href="#崩溃信息中的信息解析" class="headerlink" title="崩溃信息中的信息解析"></a>崩溃信息中的信息解析</h4><h5 id="1-1-Elapsed-total-CPU-time"><a href="#1-1-Elapsed-total-CPU-time" class="headerlink" title="1.1 Elapsed total CPU time"></a>1.1 Elapsed total CPU time</h5><p><code>Elapsed total CPU time</code> 显示CPU在挂钟时间内系统上的所有进程运行了多少时间。</p>
<p>此CPU时间以及应用程序CPU时间适用于跨CPU内核的总CPU利用率，可能超过100%。例如，如果一个CPU内核利用率为100%，第二个CPU内核利用率为20%，则总CPU利用率为120%。</p>
<h5 id="1-2-Elapsed-application-CPU-time"><a href="#1-2-Elapsed-application-CPU-time" class="headerlink" title="1.2 Elapsed application CPU time"></a>1.2 Elapsed application CPU time</h5><p><code>Elapsed application CPU time</code> 显示应用程序在挂钟时间内在CPU上运行所花费的时间。</p>
<p>如果此数字处于任一极端，则表明存在问题。如果数字很高，则应用程序正在其所有线程中执行大量工作（该数字聚合所有线程，并且不特定于主线程。）</p>
<p>如果此数字较低，则该应用程序大部分处于空闲状态，因为它正在等待系统资源，例如网络连接。</p>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><ul>
<li>异步请求</li>
<li><p>不要使用 <code>SCNetworkReachability</code>，而是使用 <code>NWPathMonitor</code> 在网络路径更改时接收更新。系统在您调用 <code>start</code>(<code>queue:</code>) 时传入的队列上提供更新，因此路径更新功能安全地脱离主线程。</p>
</li>
<li><p>在辅助线程中执行同步网络</p>
</li>
<li>大多数情况下不建议手动解析 <code>DNS</code>。使用 <code>URLSession</code> 让系统代表您处理 <code>DNS</code> 解析。如果切换非常困难，并且您仍然需要手动更改 <code>DNS</code> 地址，请使用异步 <code>API</code>，如 <code>CFHost</code> 或 中的 <code>API</code>。</li>
</ul>
<p><a href="https://developer.apple.com/documentation/xcode/addressing-watchdog-terminations#Interpret-the-App-Responsiveness-Watchdog-Information" target="_blank" rel="noopener">Addressing Watchdog Terminations</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/iOS/">iOS</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/watchdog/">watchdog</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2021 Wheat
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'GTM-NHB73SK', 'auto');
    ga('send', 'pageview');

</script>

    
<script>
    var _hmt = _hmt || [];
    ( function () {
        var hm = document.createElement( "script" );
        hm.src = "https://hm.baidu.com/hm.js?ae05530a6a007cdb8063cf611691cc3e";
        var s = document.getElementsByTagName( "script" )[ 0 ];
        s.parentNode.insertBefore( hm, s );
    } )();
</script>

  </div>
</div>
</body>
</html>