<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>block 和 weak的了解 | Wheat</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="灾难总是接踵而至，这正是世间的常理。只要找个理由，就会有谁来救你吗？要是死了，就只是说明我不过是如此程度的男人。">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="block 和 weak的了解 | Wheat">
    <meta name="twitter:description" content="灾难总是接踵而至，这正是世间的常理。只要找个理由，就会有谁来救你吗？要是死了，就只是说明我不过是如此程度的男人。">

    <meta property="og:type" content="article">
    <meta property="og:title" content="block 和 weak的了解 | Wheat">
    <meta property="og:description" content="灾难总是接踵而至，这正是世间的常理。只要找个理由，就会有谁来救你吗？要是死了，就只是说明我不过是如此程度的男人。">

    
    <meta name="author" content="Wheat">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

    
    <link rel="icon" href="/images/avatar-small.png">
    

    <meta name="generator" content="hexo"/>
    
    <link rel="alternate" type="application/rss+xml" title="Wheat" href="/atom.xml">
    

    <link rel="canonical" href="http://guohuaden.com/2016/09/27/block-and-weak/"/>

    
      
</head>

<body class="home-template no-js">
    <script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="前往 Wheat 的主页"><img src="/images/avatar.png" width="80" alt="Wheat logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for Wheat">Wheat</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">以梦为马，不负韶华</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">我是一名iOS开发工程师，正在技术的道路上前行，也希望好好的走下去。</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="访问博客" class="blog-button">博客</a></li>
            
              <li class="navigation__item"><a href="/complain">牢骚</a></li>
            
              <li class="navigation__item"><a href="/lift">生活</a></li>
            
              <li class="navigation__item"><a href="/about">关于</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  

  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/Wheat-Qin" title="wheat的GitHub主页" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- jianshu -->
  

<!-- cnblogs -->
  

<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  

<!-- Facebook -->

  
<!-- Twitter -->

  <li class="navigation__item">
    <a href="https://twitter.com/wheatDen" title="@wheat" target="_blank">
      <i class='social fa fa-twitter'></i>
      
    </a>
  </li>

  

  <li class="navigation__item">
    <a href="/atom.xml" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>



  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-slate"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2016-09-27T01:45:07.000Z" class="post-list__meta--date date">2016-09-27</time> &#8226; <span class="post-meta__tags tags">于&nbsp;
  <a class="tag-link" href="/tags/iOS/">iOS</a>
 </span>
      <span class="page-pv">
      &nbsp;阅读&nbsp;<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>
      </span> 
   
    </div>
    <h1 class="post-title">block 和 weak的了解</h1>
  </header>

  <section class="post">
    <p>果然还是对最基础的知识了解不透彻，今天看一看iOS中的两个修饰符：<code>__block</code>和<code>__weak</code> 。也是做一下温习吧。</p>
<p><strong>一、先说<code>weak</code>，&lt;弱引用&gt;</strong></p>
<p>我们知道<code>weak</code>的使用，比如声明一个控件属性，就会用到<code>weak</code>。</p>
<p>看代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property(nonatomic,weak)UILabel *label;</span><br></pre></td></tr></table></figure>
<p>当然这并不是说声明控件就一定使用<code>weak</code>，相反的我在手动创建控件是大多数会使用<code>strong</code>。但如果你比较细心的话，你会发现我们使用xib时，使用的却是<code>weak</code>这一属性。那问题来了，我们使用<code>strong</code> 和 <code>weak</code> 的时机是何时呢？咱们接着往下看。<br>从<code>storyboard</code> 或者 <code>xib</code>上创建控件 </p>
<p>在控件放在view<code>上的时候，已经形成了如下的引用关系,以<code>UILabel</code>为例：<code>UIViewController-&gt;UIView-&gt;subView-&gt; UILabel</code> ，然后你为这个<code>UILabel</code>声明一个<code>weak</code>属性。</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property(nonatomic,weak) IBOOutlet UILabel * label;</span><br></pre></td></tr></table></figure>
<p>相当于<code>xib</code>对这个<code>label</code>是强引用，你声明的属性对它是弱引用。<br>手动创建控件 </p>
<ul>
<li><strong>a). 将控件声明成<code>strong</code></strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property(nonatomic,strong) UIlabel * label;</span><br></pre></td></tr></table></figure>
<p>那么你在实现这个控件时只需这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_label = [[UIlabel alloc]init];</span><br><span class="line">[self.view addSubview:_label];</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>b). 将控件声明成weak</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property(nonatomic,weak) UIlabel * label;</span><br></pre></td></tr></table></figure>
<p>那么你在实现这个控件时需要这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UIlabel *label = [[UIlabel alloc]init];</span><br><span class="line">_label = label;</span><br><span class="line">[self.view addSubview:_btn];</span><br></pre></td></tr></table></figure>
<p>关于<code>block</code>循环引用的问题</p>
<p>由于<code>block</code>会复制外部的变量，所以如果不注意，就会造成循环引用。对于这种情况，需要将引用的一方变成<code>weak</code>，从而避免循环引用。</p>
<p>看代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">BlocksViewController *blockVC  = [[BlocksViewController alloc]init];</span><br><span class="line">__weak ViewController *weekSelf = self;</span><br><span class="line">/**</span><br><span class="line">*  1、使用弱引用来解决block循环引用问题</span><br><span class="line">*</span><br><span class="line">*  2、block能截取自动变量，并且是不能在block块中进行修改的（除非用 __block修饰符）这里的 weekSelf.textField.text 的值是被修改了，并且没有使用 __block修饰符。原因是因为textField是全局变量，如果定义一个局部变量，比如：定义个 “text”是不能被修改的，编译器会报错，</span><br><span class="line">*/</span><br><span class="line">//block回调传值</span><br><span class="line">[blockVC returnValue:^(NSString *content) &#123;</span><br><span class="line">weekSelf.textField.text = content;</span><br><span class="line">// text = content;//这里会提示错失__block;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p><strong>二、<code>strong</code>和<code>weak</code>的区别</strong></p>
<ul>
<li><p><strong>strong</strong>：强引用，也是我们通常说的引用，其存亡直接决定了所指向对象的存亡。如果不存在指向一个对象的引用，并且此对象不再显示在列表中，则此对象会被从内存中释放。</p>
</li>
<li><p><strong>weak</strong>：弱引用，不决定对象的存亡。即使一个对象被持有无数个弱引用，只要没有强引用指向它，那么还是会被清除。</p>
</li>
<li><p><strong>strong</strong>和<strong>copy</strong>是用来修饰强引用的属性，weak 用来修饰弱引用的属性；</p>
</li>
<li><p><strong>strong</strong>、<strong>weak</strong> 需要ARC支持才能使用，<strong>copy</strong>不需要ARC支持</p>
</li>
<li><p><strong>strong</strong>与<strong>retain</strong>功能相似；<strong>weak</strong>与<strong>assign</strong>相似，只是当对象消失后weak会自动把指针变为nil;</p>
</li>
</ul>
<p><strong>三、关于<code>__block</code></strong></p>
<p>先看一段代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@autoreleasepool &#123;</span><br><span class="line">__block NSInteger value = 0;</span><br><span class="line">void (^block)(void) = ^&#123;</span><br><span class="line">value = 1;</span><br><span class="line">&#125;;</span><br><span class="line">block();</span><br><span class="line">NSLog(@&quot;val = %ld&quot;, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们现在看着可能得不出什么结论，那么，我们再看下面的代码，为了直观，我以图片的形式呈现：</p>
<p><img src="http://obzx0h1re.bkt.clouddn.com/__blocktest.png" alt="block_picture1"></p>
<p><img src="http://obzx0h1re.bkt.clouddn.com/__blocktest1.png" alt="block_picture2"></p>
<p>现在对比就明显了。</p>
<p>下面总结一下：</p>
<ol>
<li><p>a) <code>__block</code>对象在<code>block</code>中是可以被修改、重新赋值的。</p>
</li>
<li><p>b)<code>__block</code>对象在<code>block</code>中不会被<code>block</code>强引用一次，从而不会出现循环引用问题。</p>
</li>
<li><p>c) <code>block</code>可以访问局部变量，但是不能修改。如果修改局部变量，需要加<code>__block</code> ,所以<code>__block</code>是让修改外部变量的值.</p>
</li>
</ol>
<p>对于 block 外的变量引用，<code>block</code> 默认是将其复制到其数据结构中来实现访问的</p>
<p><img src="http://obzx0h1re.bkt.clouddn.com/const-non-local-variables.png" alt="const-non-local-variables"></p>
<p>对于用 <code>__block</code> 修饰的外部变量引用，<code>block</code> 是复制其引用地址来实现访问的</p>
<p><img src="http://obzx0h1re.bkt.clouddn.com/mutable-non-local-variables.png" alt="mutable-non-local-variables"></p>
<p><strong>四、<strong>block 和 </strong>weak修饰符的区别</strong></p>
<ol>
<li><p><code>__block</code>不管是ARC还是MRC模式下都可以使用，可以修饰对象，还可以修饰基本数据类型。</p>
</li>
<li><p><code>__weak</code>只能在ARC模式下使用，也只能修饰对象<code>（NSString）</code>，不能修饰基本数据类型<code>（int）</code>。</p>
</li>
<li><p><code>__block</code>对象可以在<code>block</code>中被重新赋值，<code>__weak</code>不可以。</p>
</li>
</ol>
<hr>
<p> <strong>链接：</strong></p>
<p><a href="http://blog.devtang.com/2013/07/28/a-look-inside-blocks/" target="_blank" rel="noopener">谈Objective-C block的实现</a></p>
<p><a href="http://rypress.com/tutorials/objective-c/blocks" target="_blank" rel="noopener">Blocks are Objective-C`s</a></p>
<p><a href="http://www.cnblogs.com/luoxiaofu/p/5445327.html" target="_blank" rel="noopener">iOS开发-由浅至深学习block</a></p>

  </section>

</article>
<section class="read-more">
           
    
               
            <div class="read-more-item">
                <span class="read-more-item-dim">最近的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2016/10/06/DES-encryption/" title="Base64加密和DES加密、以及JAVA和iOS中DES加密统一性问题">Base64加密和DES加密、以及JAVA和iOS中DES加密统一性问题</a></h2>
                <p class="excerpt">
                
                前言我们在项目中为了安全方面的考虑，通常情况下会选择一种加密方式对需要安全性的文本进行加密，而Base64加密和DES64加密是常用的加密算法。我记得我在前一个项目中使用的就是这两种加密算法的结合：Base64 ＋ DES加密。当然这需要移动端和后台服务器做一个统一。
1、Base64加解密值得一提
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2016-10-06T14:14:00.000Z" class="post-list__meta--date date">2016-10-06</time> &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/iOS/">iOS</a>
</span><a class="btn-border-small" href="/2016/10/06/DES-encryption/">继续阅读</a></div>
                           
            </div>
        
        
               
            <div class="read-more-item">
                <span class="read-more-item-dim">更早的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2016/09/23/BlurEffect/" title="iOS模糊效果(毛玻璃效果)的实现">iOS模糊效果(毛玻璃效果)的实现</a></h2>
                <p class="excerpt">
                
                　前一段时间项目中用到毛玻璃效果，那时对UIBlurEffect类和 UIVisualEffectView这两个类做了一部分了解。但当时并没有去特别的深入研究，直到项目做完后，才静下心来好好研究了一番。记录一下。
　　iOS8之后，Apple新添加UIBlurEffect类、UIVibrancyEf
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2016-09-23T02:42:42.000Z" class="post-list__meta--date date">2016-09-23</time> &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/iOS/">iOS</a>
</span><a class="btn-border-small" href="/2016/09/23/BlurEffect/">继续阅读</a></div>
                       
            </div>
        
     
   
   
  
</section>

            
            <br><footer class="footer">
    <span class="footer__copyright">听过无数道理，还是过不好这一生。那就随着心意任性地走吧，走累的时候再安营扎寨，或者永远也不。本人邮箱：wheatden@guohuaden.com
    </span>
   
</footer>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
        </div>
    </div>

    

     
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'GTM-NHB73SK', 'auto');
	ga('send', 'pageview');
</script>

    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?ae05530a6a007cdb8063cf611691cc3e";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>



    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
    
    </script>
    
</body>
</html>
